const express = require('express')

// importing item model to access database
const Item = require('../models/item')
const Pet = require('../models/pet')

// making a router
const router = express.Router()

// DELETE - Delete
router.delete('/:id', (req, res) => {
    const itemId = req.params.id

    Item.findByIdAndRemove(itemId)
        .then(item => {
            res.redirect('/adopt-a-paw/items/index')
        })
        .catch(err => {
            res.json(err)
        })
})

// GET route for displaying an update form
router.get('/:id/edit', (req, res) => {
    // console.log('edit route here')
    const itemId = req.params.id
    Item.findById(itemId)
        .then(item => {
            res.render('items/edit', { item })
        })
        .catch(err => {
            res.json(err)
        })
})

// PUT - Update
// localhost:3000/adopt-a-paw/items/:id
router.put('/:id', (req, res) => {
    const itemId = req.params.id
    // console.log('put route here')
    Item.findByIdAndUpdate(itemId, req.body, { new: true })
        .then(item => {
            res.redirect(`${item._id}`, author)
        })
        .catch(err => {
            res.json(err)
        })
})

// GET route for displaying my form for create
router.get('/new', (req, res) => {
    // res.send('new page in route')
    
    const username = req.session.username
    const loggedIn = req.session.loggedIn
    res.render('items/new', { username, loggedIn })
})

// POST - Create
router.post('/index', (req, res) => {

    // now that we have user specific items, we'll add a username upon creation
    // remember, when we login, we saved the username to the session object
    // using the ._id to set the owner field
    
    req.body.owner = req.session.userId

    console.log(req.body)
    Item.create(req.body)
        .then(item => {
            console.log(item)
            res.redirect('/adopt-a-paw/items/index')
        })
        .catch(err => {
            res.json(err)
        })
})

// GET - Index
// localhost:3000/adopt-a-paw/items/index
router.get('/index', (req, res) => {
    // mongoose to find all items
    Item.find({})
    // // return items as json
        .then(items => {
    // res.send('item index from routes')
            res.render('items/index', { items })
        })
        .catch(err => {
            res.json(err)
        })
})

// router.get('adopt-a-paw/users/my_account', (req, res) => {
//     res.send('mine route')

    // const foo = await Item.find({ owner: req.session.userId })
    // // all code inside this function stops until we get the response from Foo.findById
    // const bar = await Pet.find({ owner: req.session.userId })
    // // again all code stops until Bar.findById finishes
    // res.render('users/user_account', { foo, bar })
// })

// router.get('/mine', (req, res) => {
//     // res.send('in mine route')
//     // find the items associated with the logged in user
//     Item.find({ owner: req.session.userId })

//         .then(items => {
//             res.render('items/index', { items })
//         })
//         .catch(error => {
//             console.log(error)
//             res.json({ error })
//         })
// })


// GET - Show
// localhost:3000/adopt-a-paw/items/:id <- change with the id being passed in
router.get('/:id', (req, res) => {
    const itemId = req.params.id

    Item.findById(itemId)
    // populate our User models fields
    // comment has an author field and that is the ref to the User model
    // always going to be a string of the value you want to populate
    // this also has to be anohter model 
    // .populate('items.author')
        // send back some json
        .then(item => {
            const userId = req.session.userId
            const username = req.session.username
            res.render('items/show', { item, userId, username })
        })
        .catch(err => {
            res.json(err)
        })
})

module.exports = router